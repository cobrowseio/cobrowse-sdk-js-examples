
ARG COBROWSEIO_GITHUB_TOKEN=""
ARG npm_config_ignore_scripts="false"

FROM node:20-alpine as deps
RUN apk add --update --no-cache wget git python3 make g++ pkgconfig pixman-dev cairo-dev pango-dev
WORKDIR /usr/src
COPY package.json package-lock.json .npmrc ./
RUN --mount=type=secret,id=cobrowseio_github_token \
  COBROWSEIO_GITHUB_TOKEN=$(cat /run/secrets/cobrowseio_github_token) \
  npm install

FROM node:20-alpine as dev
ENV NODE_ENV=development
ENV STAGE=development
RUN apk add --no-cache ca-certificates && update-ca-certificates
RUN mkdir -p /usr/src && chown node /usr/src
VOLUME /usr/src/app
COPY --from=deps --chown=node /usr/src/node_modules /usr/src/node_modules
USER node
WORKDIR /usr/src/app
CMD ["npm", "start"]
